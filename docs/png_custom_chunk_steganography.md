# ปรับปรุงเทคนิค Steganography ในไฟล์ PNG

## ข้อจำกัดของการต่อท้ายข้อมูล (Appending After IEND)

เทคนิคต่อท้ายข้อมูลหลัง `IEND` chunk ถูกมองว่าเป็นจุดอ่อนหลักของการซ่อนข้อมูลใน PNG เพราะเป็นการฝ่าฝืนรูปแบบไฟล์มาตรฐาน ซึ่งทำให้เครื่องมืออย่าง Hex Editor สามารถตรวจพบข้อมูลที่ไม่ควรจะอยู่ต่อท้ายได้ทันที จุดอ่อนสำคัญประกอบด้วย:

- **การละเมิดโครงสร้างมาตรฐานของ PNG** – ไฟล์ PNG ควรจบลงที่ `IEND` chunk ดังนั้นการมีข้อมูลอื่นต่อท้ายทำให้ไฟล์ผิดรูปแบบอย่างเห็นได้ชัด
- **ไม่มีการตรวจสอบความถูกต้องของข้อมูล** – ข้อมูลที่ต่อท้ายไม่ได้อยู่ในโครงสร้าง chunk ของ PNG จึงไม่สามารถใช้กลไก CRC-32 ที่ PNG กำหนดไว้ในการตรวจสอบความสมบูรณ์ของข้อมูลได้
- **ตรวจจับได้ง่าย** – ผู้ใช้เพียงเปิดไฟล์ด้วย Hex Editor ก็จะเห็นสตริงระบุรูปแบบ (`STEGOSIGHT::APPEND::V1`) หรือข้อมูลที่ต่อท้ายได้ทันที ทำให้เทคนิคนี้ไม่แนบเนียน

## เทคนิคใหม่: Custom Ancillary Chunk

วิธีการใหม่ใช้การสร้าง **custom ancillary chunk** (ประเภท chunk ที่ขึ้นต้นด้วยตัวพิมพ์เล็ก) เพื่อซ่อน payload ภายในโครงสร้าง PNG อย่างถูกต้อง โดยมีหลักการสำคัญดังนี้:

1. **เคารพโครงสร้างของไฟล์ PNG** – ข้อมูลถูกแทรกเป็น chunk ที่ถูกต้องก่อน `IEND` ช่วยให้ไฟล์ยังคงสอดคล้องกับมาตรฐาน PNG
2. **ใช้ค่าความยาวและ CRC-32 ตามข้อกำหนดของ PNG** – ตัว chunk เก็บขนาดข้อมูลและ CRC-32 ของ `chunk_type + chunk_data` ทำให้เครื่องมือวิเคราะห์โครงสร้าง PNG มองว่า chunk ถูกต้องและช่วยป้องกันการแก้ไขข้อมูลโดยไม่ตั้งใจ
3. **ซ่อนเมตาดาต้าไว้ใน payload** – ภายใน chunk จะเก็บชื่อไฟล์และข้อมูลจริง ช่วยให้สามารถดึงกลับมาได้พร้อมกับชื่อเดิม
4. **เสริมความปลอดภัยด้วยการตรวจสอบ CRC** – ระหว่างการถอดข้อมูล หาก CRC ไม่ตรง ระบบจะแจ้งว่า payload เสียหาย

เทคนิคนี้จึงแนบเนียนกว่าเดิมและยังตรวจจับได้ยาก เนื่องจากผู้ตรวจสอบต้องเข้าใจโครงสร้าง chunk และค่าสรุป CRC จึงจะทราบว่าเป็นข้อมูลที่เพิ่มขึ้นมาเอง ไม่ใช่ค่าที่มาจากโปรแกรมสร้าง PNG ทั่วไป

## สรุปหลักการทำงานของโค้ด

โค้ดอยู่ในโมดูล [`steganography/png_chunks.py`](../steganography/png_chunks.py) และประกอบด้วยฟังก์ชันหลักสองส่วน:

- `embed_data_in_chunk(png_filepath, file_to_hide_path, output_filepath=None, *, chunk_type=b"stGO")` – อ่านไฟล์ PNG และไฟล์ที่จะซ่อน จากนั้นสร้าง custom chunk พร้อมคำนวณ CRC-32 ก่อนสอดแทรก chunk ใหม่นี้ก่อน `IEND`. ฟังก์ชันจัดการข้อผิดพลาด เช่น ไม่พบ `IEND`, มี chunk ประเภทเดียวกันอยู่แล้ว หรือชื่อไฟล์ยาวเกินกำหนด
- `extract_data_from_chunk(stego_png_filepath, *, output_dir=None, prefix="extracted_", overwrite=False, chunk_type=b"stGO")` – สแกน chunk ในไฟล์ PNG เพื่อตามหาประเภทที่กำหนด ตรวจสอบ CRC เพื่อยืนยันความสมบูรณ์ แล้วแยกชื่อไฟล์และข้อมูลจริงเพื่อนำไปบันทึกในไดเร็กทอรีที่ต้องการ พร้อมแจ้งเตือนหากไฟล์ปลายทางมีอยู่แล้วหรือ payload เสียหาย

ทั้งสองฟังก์ชันใช้โครงสร้าง chunk ของ PNG อย่างเคร่งครัดและตรวจสอบความถูกต้องของข้อมูลทุกขั้นตอน ช่วยเพิ่มความแนบเนียนและลดความเสี่ยงที่จะถูกตรวจพบเมื่อเทียบกับการต่อท้ายข้อมูลหลัง `IEND` chunk
